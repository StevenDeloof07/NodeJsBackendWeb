import { validationResult } from 'express-validator';
import createDatabase from '../../database/connection.js'
import {generateUrl} from "../functions/url.js"

const userController = {};

userController.get_all = async (req, res) => {
    const db = createDatabase();
    const select = db.prepare('SELECT id, name FROM users');

    let users =  await select.all()
    for (let user of users) {
        //code generated by gemini. A url is generated to get to the path of a specific user
        user.details = generateUrl(req, 'users', user.id)
    }

    db.close()

    res.json(users);
}

userController.get_user = async (req, res) => {
    const db = createDatabase();
    const selectUser = db.prepare('select * from users where id=? ');
    const id = req.params.id
    const user = await selectUser.get(id);

    db.close();
    res.json(user);
}

userController.create = async (req,res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.json({errors: errors.array()})
    }

    const {name, email, birthday, about_me} = req.body

    const db = createDatabase();

    const mailCheck = db.prepare('select * from users where email=?')

    const rows = mailCheck.get(email)

    if (rows) {
        return res.json({errors: "This mail is already in use"})
    }

    const insertUser = db.prepare("insert into users(name, email, birthday, about_me) values (?, ?, ?, ?)")

    const response = await insertUser.run(name, email, birthday, about_me)

    return res.json({succes: "mail succesfully added!"});
}

userController.delete = async (req, res) => {
    const id = req.params.id

    console.log(id);
    return res.json({response: "This function doesn't work yet"})
}
export default userController